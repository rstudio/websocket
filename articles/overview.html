<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview • websocket</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Overview">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">websocket</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>

    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Learning

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/overview.html">Overview</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/websocket/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>

    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview</h1>
            
            <h4 data-toc-skip class="date">2019-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/websocket/blob/main/vignettes/overview.Rmd" class="external-link"><code>vignettes/overview.Rmd</code></a></small>
      <div class="hidden name"><code>overview.Rmd</code></div>

    </div>

    
    
<p><code>websocket</code> is a <a href="https://en.wikipedia.org/wiki/WebSocket" class="external-link">WebSocket</a> client
package for R backed by the <a href="https://github.com/zaphoyd/websocketpp" class="external-link">websocketpp</a> C++
library.</p>
<p>WebSocket clients are most commonly used from <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications" class="external-link">JavaScript
in a web browser</a>, and their use in R with this package is not much
different. The experience of using <code>websocket</code> is designed to
be similar to the experience of using WebSockets in a browser.</p>
<p>Like WebSockets in a browser, <code>websocket</code> makes it easy to
asynchronously process data from a WebSocket server. In the context of
an R or Shiny application, this functionality is useful for
incrementally consuming data from an external data source presented as a
WebSocket server.</p>
<p>The I/O for a WebSocket happens on a separate thread from the main R
thread; there is one thread for each WebSocket.</p>
<div class="section level2">
<h2 id="creating-websockets">Creating WebSockets<a class="anchor" aria-label="anchor" href="#creating-websockets"></a>
</h2>
<p>WebSockets are represented as instances of an <a href="https://github.com/r-lib/R6" class="external-link">R6</a> object, and are created with
<code>$new()</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://echo.websocket.org/"</span><span class="op">)</span></span></code></pre></div>
<p>By default, and similarly to how WebSockets in JavaScript work,
constructing a WebSocket with <code>$new()</code> will automatically
initiate the WebSocket connection. In normal usage, such as in a Shiny
app or from within a function, this default behavior is ideal. When run
interactively from the R console however, the default behavior is
problematic. The reason is that the connection will open before the user
is given an opportunity to register any event handlers, meaning messages
from the server could be dropped.</p>
<p>So, in the console, WebSockets should be created like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://echo.websocket.org/"</span>, autoConnect <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># Set up callbacks here...</span></span>
<span><span class="va">ws</span><span class="op">$</span><span class="fu">connect</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="interaction-with-later">Interaction with <code>later</code><a class="anchor" aria-label="anchor" href="#interaction-with-later"></a>
</h2>
<p>The technical reason that <code>autoConnect = FALSE</code> is
necessary at the console has to do with how <a href="https://github.com/r-lib/later" class="external-link">later</a> works.
<code>later</code> is a package that provides an event loop for R, and
the <code>websocket</code> package uses it to schedule callbacks that
run in response to WebSocket events (like incoming messages).</p>
<p>When a function has been put in to the queue with <code>later</code>,
there are two ways it could be executed. One way is when
<code><a href="https://r-lib.github.io/later/reference/run_now.html" class="external-link">later::run_now()</a></code> is called. The second way is when the R
console is idle (and the R call stack is empty): when that happens,
<code>later</code> will automatically execute callbacks from the
queue.</p>
<p>When running a block of code like this in a function, or surrounded
with <code>{</code> and <code>}</code>, the console does not have a
chance to be idle in between the lines of code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="va">ws</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://echo.websocket.org/"</span><span class="op">)</span></span>
<span>  <span class="va">ws</span><span class="op">$</span><span class="fu">onOpen</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"websocket opened"</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this code, the WebSocket has queued a connection attempt before
<code>ws$onOpen()</code> is called. However, the
<code>ws$onOpen()</code> runs <em>before</em> R tries to call any
<code>onOpen</code> callbacks, because there were no idle “ticks”
between the two lines of code for <code>later</code> to respond to any
opened connections.</p>
<p>(Technical note: <code>websocket</code> runs the I/O on a separate
thread; when an event occurs, like an open event or message, it uses
<code>later</code> to schedule a callback to run on the main R thread.
In the case above, the WebSocket connection could actually be opened –
on the I/O thread – before the main R thread calls
<code>ws$onOpen()</code> to set up the callback. If that happened it
would only be able to schedule the invocation of the <code>onOpen</code>
callback immediately; only at a later point in time, when the R console
is idle, or when <code><a href="https://r-lib.github.io/later/reference/run_now.html" class="external-link">later::run_now()</a></code> is called, would it be
able to actually execute the callbacks. So in the example above, the
<code>onOpen</code> callback is guaranteed to run when the connection is
successfully opened.)</p>
<p>Because <code>$new()</code> only <em>schedules</em> the work of
connecting — it does not perform it immediately — it’s safe within a
code block to attach handlers, because none of them can possibly run
until after the enclosing block returns.</p>
</div>
<div class="section level2">
<h2 id="adding-handlers">Adding handlers<a class="anchor" aria-label="anchor" href="#adding-handlers"></a>
</h2>
<p>After a <code>WebSocket</code> object is created, you have an
opportunity to associate handler functions with various WebSocket events
using the following R6 methods:</p>
<ol style="list-style-type: decimal">
<li>
<code>$onOpen()</code>: Invoked when the connection is first
opened</li>
<li>
<code>$onMessage()</code>: Invoked when a message is received from
the server</li>
<li>
<code>$onClose()</code>: Invoked when the client or server closes
the connection</li>
<li>
<code>$onError()</code>: Invoked when an error occurs</li>
</ol>
<p>For example, the following code instantiates a WebSocket, installs an
<code>onOpen</code> handler, and prints a message once the WebSocket is
open:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="va">ws</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://echo.websocket.org/"</span><span class="op">)</span></span>
<span>  <span class="va">ws</span><span class="op">$</span><span class="fu">onOpen</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"connected\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<blockquote>
<p>Note that because the <code>$new()</code> and <code>$onOpen()</code>
calls are within the same code block, <code>autoConnect</code> does not
need to be <code>FALSE</code>.</p>
</blockquote>
<div class="section level3">
<h3 id="event-environment">Event environment<a class="anchor" aria-label="anchor" href="#event-environment"></a>
</h3>
<p>Every handler function is passed an <code>event</code> environment.
This environment contains at least the entry <code>target</code>, which
is a reference to the WebSocket object on which the event occurred.</p>
<p>In addition to <code>target</code>, other entries are available
depending on the handler type:</p>
<ul>
<li>
<code>$onMessage()</code>
<ul>
<li>
<code>data</code>: Text or binary data received from the server, as
a character vector or raw vector, respectively</li>
</ul>
</li>
<li>
<code>$onClose()</code>
<ul>
<li>
<code>code</code>: The numeric <a href="https://developer.mozilla.org/en-US/docs/Web/API/CloseEvent" class="external-link">close
code</a>
</li>
<li>
<code>reason</code>: Character vector, the reason for closing</li>
</ul>
</li>
<li>
<code>$onError()</code>
<ul>
<li>
<code>message</code>: Character vector, an error message</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="removing-handlers">Removing handlers<a class="anchor" aria-label="anchor" href="#removing-handlers"></a>
</h2>
<p>Multiple handler functions for the same event type can be added to
the WebSocket by repeatedly calling a handler registration method such
as <code>$onMessage()</code>.</p>
<p>The return value of every registration method is a zero-argument
function that may be invoked to <strong>deregister</strong> the handler
function.</p>
<p>The following is an example of an <code>$onMessage()</code> handler
that immediately removes itself:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">{</span></span>
<span>  <span class="va">ws</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/WebSocket.html">WebSocket</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="st">"ws://echo.websocket.org/"</span><span class="op">)</span></span>
<span>  <span class="va">removeThis</span> <span class="op">&lt;-</span> <span class="va">ws</span><span class="op">$</span><span class="fu">onMessage</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"this is the last time i'll run\n"</span><span class="op">)</span></span>
<span>    <span class="fu">removeThis</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">ws</span><span class="op">$</span><span class="fu">onOpen</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">event</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"one"</span><span class="op">)</span></span>
<span>    <span class="va">ws</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="st">"two"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Even though <code>ws$send()</code> is called twice in the
<code>$onOpen()</code> handler function, the <code>$onMessage()</code>
handler function is only run once.</p>
<div class="section level3">
<h3 id="other-notes">Other notes<a class="anchor" aria-label="anchor" href="#other-notes"></a>
</h3>
<ul>
<li>As long as a WebSocket object has an open connection, it will not be
eligible for garbage collection, even if you lose all your references to
the object, because the callback scheduling system maintains a reference
to the object. This means that any callbacks on the WebSocket will
continue to execute. If the connection is closed, the callback
scheduling system will drop its references to the WebSocket object, and
it will then be eligible for garbage collection.</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Winston Chang, Joe Cheng, Alan Dipert, Barbara Borges.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({


    apiKey: '9e39a401e6bab5df9d3b823b69a4085b',
    indexName: 'websocket',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
